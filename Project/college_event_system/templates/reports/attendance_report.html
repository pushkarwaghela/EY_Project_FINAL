<!-- core/templates/reports/attendance_report.html -->
<div class="row">
    <div class="col-md-12">
        <div class="card shadow mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-calendar-check"></i> Attendance Report Summary</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h2 class="text-primary">{{ report.data.total_attendance|default:"0" }}</h2>
                                <p class="text-muted mb-0">Total Attendance</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h2 class="text-success">
                                    {% if report.data.by_method and report.data.by_method.0 %}
                                        {{ report.data.by_method.0.count|default:"0" }}
                                    {% else %}
                                        0
                                    {% endif %}
                                </h2>
                                <p class="text-muted mb-0">QR Scans</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h2 class="text-warning">
                                    {% if report.data.by_method and report.data.by_method.1 %}
                                        {{ report.data.by_method.1.count|default:"0" }}
                                    {% else %}
                                        0
                                    {% endif %}
                                </h2>
                                <p class="text-muted mb-0">Manual Entries</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h2 class="text-danger">
                                    {% if report.data.by_day %}
                                        {{ report.data.by_day|length }}
                                    {% else %}
                                        0
                                    {% endif %}
                                </h2>
                                <p class="text-muted mb-0">Days with Attendance</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> Daily Attendance Trend</h5>
            </div>
            <div class="card-body">
                {% if report.data.by_day %}
                    <canvas id="attendanceChart" height="100"></canvas>
                {% else %}
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle"></i> No daily attendance data available.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Attendance by Method</h5>
            </div>
            <div class="card-body">
                {% if report.data.by_method %}
                    <canvas id="methodChart" height="100"></canvas>
                {% else %}
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle"></i> No method data available.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if report.data.by_event %}
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-star"></i> Top Events by Attendance</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Event</th>
                                <th>Attendance Count</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in report.data.by_event|slice:":5" %}
                            <tr>
                                <td>{{ event.event__title|default:"Unknown Event" }}</td>
                                <td>{{ event.count|default:"0" }}</td>
                                <td>
                                    {% with total=report.data.total_attendance|default:1 %}
                                    {% widthratio event.count total 100 as percentage %}
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             style="width: {{ percentage }}%">
                                            {{ percentage }}%
                                        </div>
                                    </div>
                                    {% endwith %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if report.data.by_day %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Prepare data from Django template
    const byDayData = {{ report.data.by_day|safe }};
    
    if (byDayData && byDayData.length > 0) {
        // Format dates for chart labels
        const labels = byDayData.map(item => {
            if (item.marked_at__date) {
                const date = new Date(item.marked_at__date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            return 'Unknown';
        });
        
        const values = byDayData.map(item => item.count || 0);
        
        // Attendance Line Chart
        const ctx1 = document.getElementById('attendanceChart');
        if (ctx1) {
            new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Attendance',
                        data: values,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Attendance Count'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });
        }
    }
});
</script>
{% endif %}

{% if report.data.by_method %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const byMethodData = {{ report.data.by_method|safe }};
    
    if (byMethodData && byMethodData.length > 0) {
        const methodLabels = byMethodData.map(item => {
            if (item.method) {
                return item.method.charAt(0).toUpperCase() + item.method.slice(1);
            }
            return 'Unknown';
        });
        
        const methodValues = byMethodData.map(item => item.count || 0);
        const total = methodValues.reduce((a, b) => a + b, 0);
        
        // Method Doughnut Chart
        const ctx2 = document.getElementById('methodChart');
        if (ctx2) {
            new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: methodLabels,
                    datasets: [{
                        data: methodValues,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
    }
});
</script>
{% endif %}

<style>
.progress {
    border-radius: 10px;
}

.progress-bar {
    border-radius: 10px;
    font-size: 12px;
    line-height: 20px;
}

.card {
    border: none;
    border-radius: 10px;
}

canvas {
    width: 100% !important;
}
</style>