{% extends 'base.html' %}
{% load static %}

{% block title %}
Attendance System - Smart College Event System
{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
        transition: transform 0.3s;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .badge.bg-qr { background: #2ec4b6 !important; }
    .badge.bg-manual { background: #4361ee !important; }
    .badge.bg-face { background: #f72585 !important; }
    .badge.bg-nfc { background: #7209b7 !important; }

    .scanner-container {
        width: 100%;
        height: 300px;
        background: #f8f9fa;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
    }

    .qr-preview {
        width: 250px;
        height: 250px;
        border: 3px dashed #4361ee;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        padding: 15px;
        min-width: 300px;
        transform: translateX(400px);
        transition: transform 0.3s ease;
    }

    .toast-notification.show {
        transform: translateX(0);
    }

    .toast-success { border-left: 4px solid #28a745; }
    .toast-error { border-left: 4px solid #dc3545; }
    .toast-info { border-left: 4px solid #17a2b8; }

    .action-card {
        transition: all 0.3s;
        border: 2px solid transparent;
    }

    .action-card:hover {
        border-color: #4361ee;
        transform: scale(1.02);
    }

    .attendance-btn {
        position: relative;
        overflow: hidden;
    }

    .attendance-btn:after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%);
        transform-origin: 50% 50%;
    }

    .attendance-btn:focus:not(:active)::after {
        animation: ripple 1s ease-out;
    }

    @keyframes ripple {
        0% {
            transform: scale(0, 0);
            opacity: 0.5;
        }
        20% {
            transform: scale(25, 25);
            opacity: 0.3;
        }
        100% {
            opacity: 0;
            transform: scale(40, 40);
        }
    }

    .pulse {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(67, 97, 238, 0); }
        100% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 fw-bold">
                <i class="fas fa-qrcode me-2 text-primary"></i>Attendance System
            </h1>
            <p class="text-muted">Mark and manage attendance for college events</p>
        </div>
        <div class="col-auto">
            {% if is_admin %}
            <a href="{% url 'generate_qr' %}" class="btn btn-primary">
                <i class="fas fa-qrcode me-1"></i> Generate QR Codes
            </a>
            <a href="{% url 'attendance_list' %}" class="btn btn-outline-primary ms-2">
                <i class="fas fa-list me-1"></i> View All Records
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-normal mb-2">Total Attendance</h6>
                            <h2 class="fw-bold mb-0">{{ total_attendance }}</h2>
                        </div>
                        <div class="icon-circle">
                            <i class="fas fa-clipboard-check fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-normal mb-2">Present Count</h6>
                            <h2 class="fw-bold mb-0">{{ present_count }}</h2>
                        </div>
                        <div class="icon-circle">
                            <i class="fas fa-user-check fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-normal mb-2">On Time</h6>
                            <h2 class="fw-bold mb-0">{{ on_time_count }}</h2>
                        </div>
                        <div class="icon-circle">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-normal mb-2">Day Streak</h6>
                            <h2 class="fw-bold mb-0">{{ streak_count }}</h2>
                        </div>
                        <div class="icon-circle">
                            <i class="fas fa-fire fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Left Column: Actions -->
        <div class="col-lg-4 mb-4">
            {% if is_student %}
            <!-- Student Actions -->
            <div class="card mb-4 action-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user-graduate me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success w-100 mb-3 attendance-btn pulse" 
                            data-bs-toggle="modal" 
                            data-bs-target="#qrScannerModal">
                        <i class="fas fa-camera me-2"></i> Scan Event QR Code
                    </button>

                    <button class="btn btn-primary w-100 mb-3 attendance-btn" 
                            data-bs-toggle="modal"
                            data-bs-target="#manualAttendanceModal">
                        <i class="fas fa-keyboard me-2"></i> Enter Event Code
                    </button>

                    <button class="btn btn-outline-primary w-100 mb-3"
                            onclick="generatePersonalQR()">
                        <i class="fas fa-id-card me-2"></i> Generate My QR
                    </button>

                    <button class="btn btn-info w-100 attendance-btn" 
                            data-bs-toggle="modal" 
                            data-bs-target="#attendanceHistoryModal">
                        <i class="fas fa-history me-2"></i> View My History
                    </button>
                </div>
            </div>

            <!-- My Personal QR Code -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-id-card me-2"></i>My Identity QR</h5>
                </div>
                <div class="card-body text-center">
                    <div id="personalQrCode" class="mb-3">
                        <div class="qr-preview mx-auto" id="qrPreview">
                            <div class="text-center text-muted">
                                <i class="fas fa-qrcode fa-3x mb-3"></i>
                                <p>Your QR code will appear here</p>
                            </div>
                        </div>
                    </div>
                    <div class="student-info mt-3 p-3 bg-light rounded">
                        <p class="mb-1"><strong>Student ID:</strong> {{ request.user.student_id }}</p>
                        <p class="mb-0"><strong>Name:</strong> {{ request.user.get_full_name|default:request.user.username }}</p>
                    </div>
                    <small class="text-muted d-block mt-2">Show this QR to admin for manual attendance</small>
                </div>
            </div>
            {% endif %}

            {% if is_admin or is_organizer %}
            <!-- Admin/Organizer Actions -->
            <div class="card action-card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-user-shield me-2"></i>Admin Actions</h5>
                </div>
                <div class="card-body">
                    <a href="{% url 'generate_qr' %}" class="btn btn-warning w-100 mb-3">
                        <i class="fas fa-qrcode me-2"></i> Generate Event QR Codes
                    </a>

                    <button class="btn btn-primary w-100 mb-3" 
                            data-bs-toggle="modal"
                            data-bs-target="#adminManualAttendance">
                        <i class="fas fa-user-check me-2"></i> Mark Student Attendance
                    </button>

                    <a href="{% url 'attendance_list' %}" class="btn btn-outline-primary w-100">
                        <i class="fas fa-list me-2"></i> Manage All Records
                    </a>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column: Ongoing Events & Recent Attendance -->
        <div class="col-lg-8">
            <!-- Ongoing Events -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-day me-2"></i>
                        Ongoing Events ({{ today|date:"F d, Y" }})
                        <span class="badge bg-primary ms-2">{{ ongoing_events|length }}</span>
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshOngoingEvents()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    {% if ongoing_events %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Event</th>
                                    <th>Time</th>
                                    <th>Venue</th>
                                    <th>Status</th>
                                    {% if is_student %}
                                    <th>Action</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for event in ongoing_events %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="event-icon me-3">
                                                <i class="fas fa-{{ event.icon }} text-primary"></i>
                                            </div>
                                            <div>
                                                <strong>{{ event.title }}</strong>
                                                <br>
                                                <small class="text-muted">{{ event.category|title }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-nowrap">
                                            {{ event.start_time|time:"g:i A" }}<br>
                                            <small>to {{ event.end_time|time:"g:i A" }}</small>
                                        </div>
                                    </td>
                                    <td>{{ event.venue }}</td>
                                    <td>
                                        {% if is_student and event.attendance_marked %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle me-1"></i>Marked
                                        </span>
                                        {% else %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-clock me-1"></i>Active
                                        </span>
                                        {% endif %}
                                    </td>
                                    {% if is_student %}
                                    <td>
                                        {% if event.can_mark_attendance %}
                                        <button class="btn btn-sm btn-success mark-attendance-btn"
                                                data-event-id="{{ event.event_id }}">
                                            <i class="fas fa-check me-1"></i> Mark Now
                                        </button>
                                        {% elif event.attendance_marked %}
                                        <span class="text-success">
                                            <i class="fas fa-check-circle me-1"></i>Done
                                        </span>
                                        {% else %}
                                        <span class="text-muted small">Not Available</span>
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <h5>No ongoing events</h5>
                        <p class="text-muted">There are no events currently in progress.</p>
                        <a href="{% url 'events' %}" class="btn btn-outline-primary mt-2">
                            <i class="fas fa-calendar me-1"></i> View All Events
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Recent Attendance -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Recent Attendance Records
                        <span class="badge bg-primary ms-2">{{ recent_attendance|length }}</span>
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshRecentAttendance()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    {% if recent_attendance %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Event</th>
                                    {% if is_admin or is_organizer %}
                                    <th>Student</th>
                                    {% endif %}
                                    <th>Method</th>
                                    <th>Status</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in recent_attendance %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="me-2">
                                                <i class="fas fa-calendar text-primary"></i>
                                            </div>
                                            <div>
                                                <small>{{ record.marked_at|date:"M d" }}</small>
                                                <br>
                                                <small class="text-muted">{{ record.marked_at|time:"g:i A" }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <strong>{{ record.event.title|truncatechars:30 }}</strong>
                                        <br>
                                        <small class="text-muted">{{ record.event.venue|truncatechars:20 }}</small>
                                    </td>
                                    {% if is_admin or is_organizer %}
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if record.student.profile_picture %}
                                            <img src="{{ record.student.profile_picture.url }}" 
                                                 class="rounded-circle me-2"
                                                 style="width: 24px; height: 24px; object-fit: cover;">
                                            {% endif %}
                                            <div>
                                                <div class="small">{{ record.student.get_full_name|default:record.student.username }}</div>
                                                <small class="text-muted">{{ record.student.student_id }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    {% endif %}
                                    <td>
                                        <span class="badge bg-{{ record.method }}">
                                            <i class="fas fa-{{ record.method_icon }} me-1"></i>
                                            {{ record.get_method_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if record.verified %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle me-1"></i> Verified
                                        </span>
                                        {% else %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-clock me-1"></i> Pending
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-info"
                                                onclick="viewAttendanceDetails('{{ record.attendance_id }}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-history fa-3x text-muted mb-3"></i>
                        <h5>No attendance records yet</h5>
                        <p class="text-muted">Attendance records will appear here once marked.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- QR Scanner Modal -->
<div class="modal fade" id="qrScannerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-camera me-2"></i>QR Code Scanner</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="stopScanner()"></button>
            </div>
            <div class="modal-body">
                <div class="scanner-container" id="scanner-container">
                    <div class="text-center w-100 h-100 d-flex flex-column align-items-center justify-content-center">
                        <i class="fas fa-camera fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-3">Click Start Scanner to begin</p>
                        <button class="btn btn-primary" onclick="startQRScanner()">
                            <i class="fas fa-play me-1"></i> Start Scanner
                        </button>
                    </div>
                </div>
                <div id="qr-result" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Manual Attendance Modal -->
<div class="modal fade" id="manualAttendanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-keyboard me-2"></i>Manual Attendance Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="manualAttendanceForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="event_code" class="form-label">Event Code</label>
                        <input type="text" class="form-control" id="event_code"
                               placeholder="Enter event code (e.g., EVT-001)" required>
                        <div class="form-text">Get the event code from the organizer or event details.</div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check me-1"></i> Mark Attendance
                        </button>
                    </div>
                </form>
                <div id="manualAttendanceResult" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Manual Attendance Modal -->
{% if is_admin or is_organizer %}
<div class="modal fade" id="adminManualAttendance" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-check me-2"></i>Mark Attendance for Student</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="adminAttendanceForm" action="{% url 'mark_manual_attendance' %}" method="POST">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="student_id" class="form-label">Student ID or QR Scan</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="student_id" name="student_id"
                                   placeholder="Enter student ID or scan student QR" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="scanStudentQR()">
                                <i class="fas fa-qrcode"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="admin_event_code" class="form-label">Event Code</label>
                        <input type="text" class="form-control" id="admin_event_code" name="event_code"
                               placeholder="Enter event code" required>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-user-check me-1"></i> Mark Attendance
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Attendance History Modal -->
<div class="modal fade" id="attendanceHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-history me-2"></i>My Attendance History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="attendanceHistoryContent">
                    <!-- Loaded via AJAX -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading attendance history...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Details Modal -->
<div class="modal fade" id="attendanceDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Attendance Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="attendanceDetailsContent">
                <!-- Loaded via AJAX -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
    // Global scanner instance
    let html5QrCode = null;
    let isScannerActive = false;

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function () {
        // Mark attendance button handler
        document.querySelectorAll('.mark-attendance-btn').forEach(button => {
            button.addEventListener('click', function () {
                const eventId = this.dataset.eventId;
                markAttendanceViaButton(eventId);
            });
        });

        // Manual attendance form handler
        const manualForm = document.getElementById('manualAttendanceForm');
        if (manualForm) {
            manualForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const eventCode = document.getElementById('event_code').value;
                submitManualAttendance(eventCode);
            });
        }

        // Admin attendance form handler
        const adminForm = document.getElementById('adminAttendanceForm');
        if (adminForm) {
            adminForm.addEventListener('submit', function (e) {
                const studentId = document.getElementById('student_id').value;
                if (!studentId) {
                    e.preventDefault();
                    showToast('Please enter student ID or scan QR', 'error');
                }
            });
        }

        // Load attendance history when modal opens
        const historyModal = document.getElementById('attendanceHistoryModal');
        if (historyModal) {
            historyModal.addEventListener('shown.bs.modal', function () {
                loadAttendanceHistory();
            });
        }

        // Stop scanner when modal closes
        const scannerModal = document.getElementById('qrScannerModal');
        if (scannerModal) {
            scannerModal.addEventListener('hidden.bs.modal', function () {
                stopScanner();
            });
        }

        // Auto-generate personal QR if student
        {% if is_student and request.user.student_id %}
        setTimeout(() => {
            generatePersonalQR();
        }, 1000);
        {% endif %}
    });

    // ========== ATTENDANCE FUNCTIONS ==========

    // Function to mark attendance via button click
    function markAttendanceViaButton(eventId) {
        const btn = document.querySelector(`[data-event-id="${eventId}"]`);
        const originalHTML = btn.innerHTML;
        const originalClass = btn.className;
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processing...';
        btn.className = 'btn btn-sm btn-secondary';
        btn.disabled = true;

        fetch(`/attendance/mark/qr/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                qr_data: `${eventId}|direct`
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                btn.innerHTML = '<i class="fas fa-check me-1"></i> Marked ✓';
                btn.className = 'btn btn-sm btn-success';
                
                // Update stats
                updateAttendanceStats();
                
                // Reload recent attendance
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showToast(data.message || 'Failed to mark attendance', 'error');
                btn.innerHTML = originalHTML;
                btn.className = originalClass;
                btn.disabled = false;
            }
        })
        .catch(error => {
            showToast('Network error. Please try again.', 'error');
            btn.innerHTML = originalHTML;
            btn.className = originalClass;
            btn.disabled = false;
        });
    }

    // Function to submit manual attendance
    function submitManualAttendance(eventCode) {
        const resultDiv = document.getElementById('manualAttendanceResult');
        resultDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin me-2"></i> Processing attendance...
            </div>
        `;

        fetch('/attendance/quick-manual/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ event_code: eventCode })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <div class="d-flex">
                        <i class="fas fa-check-circle fa-2x me-3 text-success"></i>
                        <div>
                            <h5 class="alert-heading">Success!</h5>
                            <p>${data.message}</p>
                            <hr>
                            <div class="row">
                                <div class="col-6">
                                    <small><strong>Event:</strong></small>
                                    <p>${data.data.event}</p>
                                </div>
                                <div class="col-6">
                                    <small><strong>Time:</strong></small>
                                    <p>${data.data.time}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

                // Close modal and refresh
                setTimeout(() => {
                    $('#manualAttendanceModal').modal('hide');
                    updateAttendanceStats();
                    setTimeout(() => window.location.reload(), 1000);
                }, 2000);
            } else {
                resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <div class="d-flex">
                        <i class="fas fa-exclamation-circle fa-2x me-3 text-danger"></i>
                        <div>
                            <h5 class="alert-heading">Error!</h5>
                            <p>${data.message}</p>
                            <button class="btn btn-sm btn-outline-danger mt-2" onclick="submitManualAttendance('${eventCode}')">
                                <i class="fas fa-redo me-1"></i> Try Again
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }
        })
        .catch(error => {
            resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                <strong>Network Error:</strong> Please check your connection.
            </div>
        `;
        });
    }

    // MISSING FUNCTION: Generate personal QR code
    function generatePersonalQR() {
        const qrDiv = document.getElementById('personalQrCode');
        const qrPreview = document.getElementById('qrPreview');
        
        if (!qrPreview) {
            console.error('QR preview element not found');
            return;
        }
        
        qrPreview.innerHTML = `
            <div class="text-center w-100 h-100 d-flex flex-column align-items-center justify-content-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Generating your personal QR code...</p>
            </div>
        `;

        fetch('/attendance/generate-personal-qr/', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                qrPreview.innerHTML = `
                    <img src="${data.qr_code}" alt="Personal QR Code" 
                         class="img-fluid w-100 h-100" style="object-fit: contain;">
                `;
                showToast('Personal QR code generated!', 'success');
            } else {
                qrPreview.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                        <p>Failed to generate QR</p>
                        <button class="btn btn-sm btn-primary" onclick="generatePersonalQR()">
                            <i class="fas fa-redo me-1"></i> Retry
                        </button>
                    </div>
                `;
            }
        })
        .catch(error => {
            qrPreview.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-wifi-slash fa-2x text-danger mb-3"></i>
                    <p>Network error</p>
                </div>
            `;
        });
    }

    // MISSING FUNCTION: Load attendance history
    function loadAttendanceHistory() {
        const contentDiv = document.getElementById('attendanceHistoryContent');

        fetch('/attendance/history/')
        .then(response => response.text())
        .then(html => {
            contentDiv.innerHTML = html;
        })
        .catch(error => {
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Failed to load attendance history
                </div>
            `;
        });
    }

    // MISSING FUNCTION: View attendance details
    function viewAttendanceDetails(attendanceId) {
        console.log('Viewing details for:', attendanceId);
        
        // Show loading
        const modalContent = document.getElementById('attendanceDetailsContent');
        if (modalContent) {
            modalContent.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading details...</p>
                </div>
            `;
        }
        
        fetch(`/attendance/details/${attendanceId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (modalContent) {
                    modalContent.innerHTML = `
                        <div class="attendance-details">
                            <h6 class="text-primary mb-3">Attendance Details</h6>
                            <div class="card mb-2">
                                <div class="card-body p-3">
                                    <h6 class="card-subtitle mb-2 text-muted">Event Information</h6>
                                    <p class="mb-1"><strong>${data.event.title}</strong></p>
                                    <p class="text-muted small mb-1">${data.event.venue}</p>
                                    <p class="text-muted small">${data.event.date} • ${data.event.time}</p>
                                </div>
                            </div>
                            
                            <div class="card mb-2">
                                <div class="card-body p-3">
                                    <h6 class="card-subtitle mb-2 text-muted">Student Information</h6>
                                    <p class="mb-1"><strong>${data.student.name}</strong></p>
                                    <p class="text-muted small mb-1">ID: ${data.student.id}</p>
                                    <p class="text-muted small">Email: ${data.student.email}</p>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-body p-3">
                                    <h6 class="card-subtitle mb-2 text-muted">Attendance Details</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <p class="mb-1 small">Marked At:</p>
                                            <p class="fw-bold">${data.attendance.marked_at}</p>
                                        </div>
                                        <div class="col-6">
                                            <p class="mb-1 small">Method:</p>
                                            <span class="badge bg-${data.attendance.method.toLowerCase()}">
                                                ${data.attendance.method}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <p class="mb-1 small">Status:</p>
                                            <span class="badge bg-${data.attendance.status_color}">
                                                ${data.attendance.status}
                                            </span>
                                        </div>
                                        <div class="col-6">
                                            <p class="mb-1 small">Verified:</p>
                                            <span class="badge ${data.attendance.verified ? 'bg-success' : 'bg-warning'}">
                                                ${data.attendance.verified ? 'Yes' : 'No'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('attendanceDetailsModal'));
                modal.show();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (modalContent) {
                modalContent.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Failed to load attendance details
                    </div>
                `;
            }
        });
    }

    // MISSING FUNCTION: Refresh ongoing events
    function refreshOngoingEvents() {
        showToast('Refreshing ongoing events...', 'info');
        
        // Reload the page section
        fetch('/attendance/ongoing-events/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Events refreshed', 'success');
                // You can implement more specific DOM updates here
                window.location.reload(); // Simple reload for now
            }
        })
        .catch(error => {
            showToast('Failed to refresh events', 'error');
        });
    }

    // MISSING FUNCTION: Refresh recent attendance
    function refreshRecentAttendance() {
        showToast('Refreshing attendance records...', 'info');
        
        // Reload the page section
        fetch('/attendance/get-recent/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Attendance records refreshed', 'success');
                // You can implement more specific DOM updates here
                window.location.reload(); // Simple reload for now
            }
        })
        .catch(error => {
            showToast('Failed to refresh attendance', 'error');
        });
    }

    // ========== QR SCANNER FUNCTIONS ==========

    // QR Scanner functions
    window.startQRScanner = function () {
        if (isScannerActive) return;
        
        const container = document.getElementById('scanner-container');
        const resultDiv = document.getElementById('qr-result');

        if (!container) {
            showToast('Scanner container not found', 'error');
            return;
        }

        // Clear previous scanner
        container.innerHTML = '';
        resultDiv.innerHTML = '';

        // Check if Html5Qrcode is available
        if (typeof Html5Qrcode === 'undefined') {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    QR Scanner library not loaded. Please refresh the page.
                </div>
            `;
            return;
        }

        html5QrCode = new Html5Qrcode("scanner-container");
        const config = {
            fps: 30,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0
        };

        html5QrCode.start(
            { facingMode: "environment" },
            config,
            onScanSuccess,
            onScanError
        ).then(() => {
            isScannerActive = true;
            container.style.border = '3px solid #28a745';
        }).catch(err => {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Camera Error:</strong> ${err.message}
                    <p class="mt-2">Please ensure you have granted camera permission.</p>
                    <button class="btn btn-sm btn-primary mt-2" onclick="startQRScanner()">
                        <i class="fas fa-redo me-1"></i> Retry
                    </button>
                </div>
            `;
        });

        function onScanSuccess(decodedText) {
            // Stop scanner
            stopScanner();
            
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>QR Code Scanned!</strong>
                    <p class="mt-2">Processing attendance...</p>
                </div>
            `;

            // Process the scanned QR code
            processScannedQR(decodedText);
        }

        function onScanError(error) {
            // Ignore common scan errors
            if (!error.includes('NotFoundException')) {
                console.log('Scan error:', error);
            }
        }

        function processScannedQR(qrData) {
            fetch('/attendance/mark/qr/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ qr_data: qrData })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <div class="d-flex">
                            <i class="fas fa-check-circle fa-2x me-3 text-success"></i>
                            <div>
                                <h5 class="alert-heading">Success!</h5>
                                <p>${data.message}</p>
                                ${data.data ? `
                                    <hr>
                                    <div class="row">
                                        <div class="col-6">
                                            <small><strong>Event:</strong></small>
                                            <p>${data.data.event}</p>
                                        </div>
                                        <div class="col-6">
                                            <small><strong>Time:</strong></small>
                                            <p>${data.data.time}</p>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;

                    // Close modal after 3 seconds and refresh
                    setTimeout(() => {
                        $('#qrScannerModal').modal('hide');
                        updateAttendanceStats();
                        setTimeout(() => window.location.reload(), 1000);
                    }, 3000);
                } else {
                    resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <div class="d-flex">
                            <i class="fas fa-exclamation-circle fa-2x me-3 text-danger"></i>
                            <div>
                                <h5 class="alert-heading">Error!</h5>
                                <p>${data.message}</p>
                                <button class="btn btn-sm btn-outline-danger mt-2" onclick="startQRScanner()">
                                    <i class="fas fa-redo me-1"></i> Scan Again
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Network Error:</strong> Please check your connection.
                </div>
            `;
            });
        }
    };

    window.stopScanner = function () {
        if (html5QrCode && isScannerActive) {
            html5QrCode.stop()
                .then(() => {
                    isScannerActive = false;
                    const container = document.getElementById('scanner-container');
                    if (container) container.style.border = 'none';
                })
                .catch(err => {
                    console.log('Error stopping scanner:', err);
                });
        }
    };

    // ========== UTILITY FUNCTIONS ==========

    // Utility function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Toast notification system
    function showToast(message, type = 'info') {
        // Remove existing toasts
        document.querySelectorAll('.toast-notification').forEach(toast => toast.remove());

        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        toast.innerHTML = `
            <div class="toast-content d-flex align-items-center">
                <div class="toast-icon me-3">
                    ${type === 'success' ? '<i class="fas fa-check-circle text-success fa-lg"></i>' :
                      type === 'error' ? '<i class="fas fa-exclamation-circle text-danger fa-lg"></i>' :
                      '<i class="fas fa-info-circle text-info fa-lg"></i>'}
                </div>
                <div class="toast-message flex-grow-1">${message}</div>
                <button class="btn-close ms-2" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;

        document.body.appendChild(toast);

        // Animate in
        setTimeout(() => toast.classList.add('show'), 10);

        // Auto remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }
        }, 5000);
    }

    // Update attendance stats
    function updateAttendanceStats() {
        fetch('/attendance/stats/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update stats cards
                const statCards = document.querySelectorAll('.stat-card');
                if (statCards.length >= 4) {
                    statCards[0].querySelector('h2').textContent = data.total_attendance;
                    statCards[1].querySelector('h2').textContent = data.present_count;
                    statCards[2].querySelector('h2').textContent = data.on_time_count;
                    statCards[3].querySelector('h2').textContent = data.streak_count;
                }
            }
        });
    }

    // Scan student QR for admin
    function scanStudentQR() {
        showToast('Open your phone camera to scan student QR code', 'info');
        // In a real implementation, this would open a QR scanner
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Check if user is student and generate QR automatically
        {% if is_student %}
        setTimeout(generatePersonalQR, 1000);
        {% endif %}
        
        // Update stats every 30 seconds
        setInterval(updateAttendanceStats, 30000);
    });
</script>
<style>
    /* Toast notifications */
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1060; /* Higher than modal z-index (1050) */
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        padding: 15px;
        min-width: 300px;
        transform: translateX(400px);
        transition: transform 0.3s ease;
    }

    .toast-notification.show {
        transform: translateX(0);
    }

    .toast-success { border-left: 4px solid #28a745; }
    .toast-error { border-left: 4px solid #dc3545; }
    .toast-info { border-left: 4px solid #17a2b8; }

    /* Fix modal focus issue */
    .modal {
        outline: none !important;
    }
    
    .modal.show {
        display: block !important;
    }
    
    /* Ensure buttons are properly styled */
    .attendance-btn {
        transition: all 0.3s;
    }
    
    .attendance-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}