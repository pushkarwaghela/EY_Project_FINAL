<!-- templates/crud/generate_qr.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}
Generate QR Codes - Admin
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 fw-bold">
                <i class="fas fa-qrcode me-2"></i>Generate QR Codes
            </h1>
            <p class="text-muted">Generate QR codes for event attendance</p>
        </div>
    </div>

    <div class="row">
        <!-- Event Selection -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-calendar me-2"></i>Select Event</h5>
                </div>
                <div class="card-body">
                    <form id="qrGenerationForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="eventSelect" class="form-label">Choose Event</label>
                            <select class="form-select" id="eventSelect" required>
                                <option value="">Select an event</option>
                                {% for event in events %}
                                <option value="{{ event.event_id }}" 
                                        data-title="{{ event.title }}"
                                        data-time="{{ event.start_time|time:'g:i A' }} - {{ event.end_time|time:'g:i A' }}"
                                        data-venue="{{ event.venue }}">
                                    {{ event.title }} ({{ event.date }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-qrcode me-1"></i> Generate QR Code
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Recent Events -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-history me-2"></i>Recent Events</h6>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for event in recent_events %}
                        <a href="#" class="list-group-item list-group-item-action" 
                           onclick="selectEvent('{{ event.event_id }}')">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ event.title }}</h6>
                                <small>{{ event.date }}</small>
                            </div>
                            <small class="text-muted">{{ event.venue }}</small>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Code Display -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-image me-2"></i>QR Code</h5>
                </div>
                <div class="card-body">
                    <div id="qrResult" class="text-center py-5">
                        <div class="placeholder-content">
                            <i class="fas fa-qrcode fa-4x text-muted mb-3"></i>
                            <h5>No QR Code Generated</h5>
                            <p class="text-muted">Select an event and generate QR code to display here.</p>
                        </div>
                    </div>
                    
                    <div id="eventInfo" class="mt-4" style="display: none;">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 id="eventTitle" class="mb-3"></h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Time:</strong></p>
                                        <p id="eventTime" class="text-muted"></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Venue:</strong></p>
                                        <p id="eventVenue" class="text-muted"></p>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <p class="mb-1"><strong>Instructions:</strong></p>
                                    <ul class="small text-muted">
                                        <li>Display this QR code at the event venue</li>
                                        <li>Students should scan this with their phone camera</li>
                                        <li>QR code expires when event ends</li>
                                        <li>Keep this QR code secure</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <button class="btn btn-success" onclick="downloadQRCode()">
                                <i class="fas fa-download me-1"></i> Download QR Code
                            </button>
                            <button class="btn btn-outline-primary ms-2" onclick="printQRCode()">
                                <i class="fas fa-print me-1"></i> Print
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .placeholder-content {
        opacity: 0.7;
    }
    
    #qrResult img {
        max-width: 100%;
        height: auto;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 10px;
        background: white;
    }
</style>

<script>
    document.getElementById('qrGenerationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const eventId = document.getElementById('eventSelect').value;
        if (!eventId) {
            alert('Please select an event');
            return;
        }
        
        generateQRCode(eventId);
    });
    
    function selectEvent(eventId) {
        document.getElementById('eventSelect').value = eventId;
        generateQRCode(eventId);
    }
    
    function generateQRCode(eventId) {
        const qrResult = document.getElementById('qrResult');
        const eventInfo = document.getElementById('eventInfo');
        const eventTitle = document.getElementById('eventTitle');
        const eventTime = document.getElementById('eventTime');
        const eventVenue = document.getElementById('eventVenue');
        
        // Get selected option data
        const selectedOption = document.querySelector(`#eventSelect option[value="${eventId}"]`);
        if (!selectedOption) return;
        
        // Show loading
        qrResult.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Generating QR...</span>
                </div>
                <p class="mt-2">Generating QR code...</p>
            </div>
        `;
        
        // Fetch QR code from server
        fetch(`/manage/generate-qr/${eventId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Display QR code
                    qrResult.innerHTML = `
                        <img src="${data.qr_code}" alt="Event QR Code" id="qrImage">
                        <p class="mt-3 text-muted">Scan this QR code to mark attendance</p>
                    `;
                    
                    // Display event info
                    eventTitle.textContent = selectedOption.dataset.title;
                    eventTime.textContent = selectedOption.dataset.time;
                    eventVenue.textContent = selectedOption.dataset.venue;
                    eventInfo.style.display = 'block';
                    
                    // Store QR data for download
                    qrResult.dataset.qrCode = data.qr_code;
                    qrResult.dataset.eventTitle = selectedOption.dataset.title;
                } else {
                    qrResult.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            ${data.message}
                        </div>
                    `;
                    eventInfo.style.display = 'none';
                }
            })
            .catch(error => {
                qrResult.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Network error. Please try again.
                    </div>
                `;
                eventInfo.style.display = 'none';
            });
    }
    
    function downloadQRCode() {
        const qrImage = document.getElementById('qrImage');
        const eventTitle = document.getElementById('eventTitle').textContent;
        
        if (!qrImage) {
            alert('No QR code to download');
            return;
        }
        
        // Create download link
        const link = document.createElement('a');
        link.download = `QR_${eventTitle.replace(/\s+/g, '_')}.png`;
        link.href = qrImage.src;
        link.click();
    }
    
    function printQRCode() {
        const qrImage = document.getElementById('qrImage');
        const eventTitle = document.getElementById('eventTitle').textContent;
        
        if (!qrImage) {
            alert('No QR code to print');
            return;
        }
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>Print QR Code - ${eventTitle}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .qr-container { text-align: center; margin: 50px 0; }
                        .qr-container img { max-width: 400px; }
                        .event-info { margin-top: 30px; }
                        @media print {
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="qr-container">
                        <h2>${eventTitle}</h2>
                        <p>Event Attendance QR Code</p>
                        <img src="${qrImage.src}" alt="QR Code">
                        <div class="event-info">
                            <p><strong>Instructions:</strong> Scan this QR code to mark attendance</p>
                            <p><em>Generated on ${new Date().toLocaleDateString()}</em></p>
                        </div>
                    </div>
                    <script>
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
            </html>
        `);
        printWindow.document.close();
    }
</script>
{% endblock %}