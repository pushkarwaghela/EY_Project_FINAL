{% extends 'base.html' %}
{% load static %}

{% block title %}
Attendance System - Smart College Event System
{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
        transition: transform 0.3s;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .badge.bg-qr {
        background: #2ec4b6 !important;
    }

    .badge.bg-manual {
        background: #4361ee !important;
    }

    .badge.bg-face {
        background: #f72585 !important;
    }

    .badge.bg-nfc {
        background: #7209b7 !important;
    }

    .scanner-container {
        width: 100%;
        height: 300px;
        background: #f8f9fa;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
    }

    .qr-preview {
        width: 250px;
        height: 250px;
        border: 3px dashed #4361ee;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        padding: 15px;
        min-width: 300px;
        transform: translateX(400px);
        transition: transform 0.3s ease;
    }

    .toast-notification.show {
        transform: translateX(0);
    }

    .toast-success {
        border-left: 4px solid #28a745;
    }

    .toast-error {
        border-left: 4px solid #dc3545;
    }

    .toast-info {
        border-left: 4px solid #17a2b8;
    }

    .action-card {
        transition: all 0.3s;
        border: 2px solid transparent;
    }

    .action-card:hover {
        border-color: #4361ee;
        transform: scale(1.02);
    }

    .attendance-btn {
        position: relative;
        overflow: hidden;
    }

    .attendance-btn:after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%);
        transform-origin: 50% 50%;
    }

    .attendance-btn:focus:not(:active)::after {
        animation: ripple 1s ease-out;
    }

    @keyframes ripple {
        0% {
            transform: scale(0, 0);
            opacity: 0.5;
        }

        20% {
            transform: scale(25, 25);
            opacity: 0.3;
        }

        100% {
            opacity: 0;
            transform: scale(40, 40);
        }
    }

    .pulse {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(67, 97, 238, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(67, 97, 238, 0);
        }
    }

    /* QR Scanner specific styles */
    #qr-reader {
        position: relative;
    }

    #qr-reader video {
        width: 100% !important;
        height: 300px !important;
        object-fit: cover;
        border-radius: 4px;
    }

    #qr-reader__scan_region {
        display: flex;
        justify-content: center;
    }

    #qr-reader__dashboard_section {
        padding: 10px;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 0 0 4px 4px;
        color: white;
    }

    .scanner-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
    }

    .scanner-frame {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 250px;
        height: 250px;
        border: 2px solid #28a745;
        border-radius: 8px;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
    }

    .scanner-corner {
        position: absolute;
        width: 30px;
        height: 30px;
        border-color: #28a745;
    }

    .scanner-corner.tl {
        top: -2px;
        left: -2px;
        border-top: 4px solid;
        border-left: 4px solid;
        border-radius: 8px 0 0 0;
    }

    .scanner-corner.tr {
        top: -2px;
        right: -2px;
        border-top: 4px solid;
        border-right: 4px solid;
        border-radius: 0 8px 0 0;
    }

    .scanner-corner.bl {
        bottom: -2px;
        left: -2px;
        border-bottom: 4px solid;
        border-left: 4px solid;
        border-radius: 0 0 0 8px;
    }

    .scanner-corner.br {
        bottom: -2px;
        right: -2px;
        border-bottom: 4px solid;
        border-right: 4px solid;
        border-radius: 0 0 8px 0;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
        #qr-reader video {
            height: 250px !important;
        }

        .scanner-frame {
            width: 200px;
            height: 200px;
        }

        .modal-dialog {
            margin: 0.5rem;
        }
    }

    @media (orientation: landscape) and (max-height: 600px) {
        #qr-reader video {
            height: 200px !important;
        }

        .scanner-frame {
            width: 180px;
            height: 180px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 fw-bold">
                <i class="fas fa-qrcode me-2 text-primary"></i>Attendance System
            </h1>
            <p class="text-muted">Mark and manage attendance for college events</p>
        </div>
        <div class="col-auto">
            {% if is_admin %}
            <a href="{% url 'generate_qr' %}" class="btn btn-primary">
                <i class="fas fa-qrcode me-1"></i> Generate QR Codes
            </a>
            <a href="{% url 'attendance_list' %}" class="btn btn-outline-primary ms-2">
                <i class="fas fa-list me-1"></i> View All Records
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-normal mb-2">Total Attendance</h6>
                            <h2 class="fw-bold mb-0">{{ total_attendance }}</h2>
                        </div>
                        <div class="icon-circle">
                            <i class="fas fa-clipboard-check fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-normal mb-2">Present Count</h6>
                            <h2 class="fw-bold mb-0">{{ present_count }}</h2>
                        </div>
                        <div class="icon-circle">
                            <i class="fas fa-user-check fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-normal mb-2">On Time</h6>
                            <h2 class="fw-bold mb-0">{{ on_time_count }}</h2>
                        </div>
                        <div class="icon-circle">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-normal mb-2">Day Streak</h6>
                            <h2 class="fw-bold mb-0">{{ streak_count }}</h2>
                        </div>
                        <div class="icon-circle">
                            <i class="fas fa-fire fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Left Column: Actions -->
        <div class="col-lg-4 mb-4">
            {% if is_student %}
            <!-- Student Actions -->
            <div class="card mb-4 action-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user-graduate me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success w-100 mb-3 attendance-btn pulse" id="scanQrBtn">
                        <i class="fas fa-camera me-2"></i> Scan Event QR Code
                    </button>
                    <button class="btn btn-primary w-100 mb-3 attendance-btn" data-bs-toggle="modal"
                        data-bs-target="#manualAttendanceModal">
                        <i class="fas fa-keyboard me-2"></i> Enter Event Code
                    </button>

                    <button class="btn btn-outline-primary w-100 mb-3" onclick="generatePersonalQR()">
                        <i class="fas fa-id-card me-2"></i> Generate My QR
                    </button>

                    <button class="btn btn-info w-100 attendance-btn" data-bs-toggle="modal"
                        data-bs-target="#attendanceHistoryModal">
                        <i class="fas fa-history me-2"></i> View My History
                    </button>
                </div>
            </div>

            <!-- My Personal QR Code -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-id-card me-2"></i>My Identity QR</h5>
                </div>
                <div class="card-body text-center">
                    <div id="personalQrCode" class="mb-3">
                        <div class="qr-preview mx-auto" id="qrPreview">
                            <div class="text-center text-muted">
                                <i class="fas fa-qrcode fa-3x mb-3"></i>
                                <p>Your QR code will appear here</p>
                            </div>
                        </div>
                    </div>
                    <div class="student-info mt-3 p-3 bg-light rounded">
                        <p class="mb-1"><strong>Student ID:</strong> {{ request.user.student_id }}</p>
                        <p class="mb-0"><strong>Name:</strong> {{
                            request.user.get_full_name|default:request.user.username }}</p>
                    </div>
                    <small class="text-muted d-block mt-2">Show this QR to admin for manual attendance</small>
                </div>
            </div>
            {% endif %}

            {% if is_admin or is_organizer %}
            <!-- Admin/Organizer Actions -->
            <div class="card action-card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-user-shield me-2"></i>Admin Actions</h5>
                </div>
                <div class="card-body">
                    <a href="{% url 'generate_qr' %}" class="btn btn-warning w-100 mb-3">
                        <i class="fas fa-qrcode me-2"></i> Generate Event QR Codes
                    </a>

                    <button class="btn btn-primary w-100 mb-3" data-bs-toggle="modal"
                        data-bs-target="#adminManualAttendance">
                        <i class="fas fa-user-check me-2"></i> Mark Student Attendance
                    </button>

                    <a href="{% url 'attendance_list' %}" class="btn btn-outline-primary w-100">
                        <i class="fas fa-list me-2"></i> Manage All Records
                    </a>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column: Ongoing Events & Recent Attendance -->
        <div class="col-lg-8">
            <!-- Ongoing Events -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-day me-2"></i>
                        Ongoing Events ({{ today|date:"F d, Y" }})
                        <span class="badge bg-primary ms-2">{{ ongoing_events|length }}</span>
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshOngoingEvents()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    {% if ongoing_events %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Event</th>
                                    <th>Time</th>
                                    <th>Venue</th>
                                    <th>Status</th>
                                    {% if is_student %}
                                    <th>Action</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for event in ongoing_events %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="event-icon me-3">
                                                <i class="fas fa-{{ event.icon }} text-primary"></i>
                                            </div>
                                            <div>
                                                <strong>{{ event.title }}</strong>
                                                <br>
                                                <small class="text-muted">{{ event.category|title }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-nowrap">
                                            {{ event.start_time|time:"g:i A" }}<br>
                                            <small>to {{ event.end_time|time:"g:i A" }}</small>
                                        </div>
                                    </td>
                                    <td>{{ event.venue }}</td>
                                    <td>
                                        {% if is_student and event.attendance_marked %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle me-1"></i>Marked
                                        </span>
                                        {% else %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-clock me-1"></i>Active
                                        </span>
                                        {% endif %}
                                    </td>
                                    {% if is_student %}
                                    <td>
                                        {% if event.can_mark_attendance %}
                                        <button class="btn btn-sm btn-success mark-attendance-btn"
                                            data-event-id="{{ event.event_id }}">
                                            <i class="fas fa-check me-1"></i> Mark Now
                                        </button>
                                        {% elif event.attendance_marked %}
                                        <span class="text-success">
                                            <i class="fas fa-check-circle me-1"></i>Done
                                        </span>
                                        {% else %}
                                        <span class="text-muted small">Not Available</span>
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <h5>No ongoing events</h5>
                        <p class="text-muted">There are no events currently in progress.</p>
                        <a href="{% url 'events' %}" class="btn btn-outline-primary mt-2">
                            <i class="fas fa-calendar me-1"></i> View All Events
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Recent Attendance -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Recent Attendance Records
                        <span class="badge bg-primary ms-2">{{ recent_attendance|length }}</span>
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshRecentAttendance()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    {% if recent_attendance %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Event</th>
                                    {% if is_admin or is_organizer %}
                                    <th>Student</th>
                                    {% endif %}
                                    <th>Method</th>
                                    <th>Status</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in recent_attendance %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="me-2">
                                                <i class="fas fa-calendar text-primary"></i>
                                            </div>
                                            <div>
                                                <small>{{ record.marked_at|date:"M d" }}</small>
                                                <br>
                                                <small class="text-muted">{{ record.marked_at|time:"g:i A" }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <strong>{{ record.event.title|truncatechars:30 }}</strong>
                                        <br>
                                        <small class="text-muted">{{ record.event.venue|truncatechars:20 }}</small>
                                    </td>
                                    {% if is_admin or is_organizer %}
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if record.student.profile_picture %}
                                            <img src="{{ record.student.profile_picture.url }}"
                                                class="rounded-circle me-2"
                                                style="width: 24px; height: 24px; object-fit: cover;">
                                            {% endif %}
                                            <div>
                                                <div class="small">{{
                                                    record.student.get_full_name|default:record.student.username }}
                                                </div>
                                                <small class="text-muted">{{ record.student.student_id }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    {% endif %}
                                    <td>
                                        <span class="badge bg-{{ record.method }}">
                                            <i class="fas fa-{{ record.method_icon }} me-1"></i>
                                            {{ record.get_method_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if record.verified %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle me-1"></i> Verified
                                        </span>
                                        {% else %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-clock me-1"></i> Pending
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-info"
                                            onclick="viewAttendanceDetails('{{ record.attendance_id }}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-history fa-3x text-muted mb-3"></i>
                        <h5>No attendance records yet</h5>
                        <p class="text-muted">Attendance records will appear here once marked.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Simplified QR Scanner Modal -->
<div class="modal fade" id="qrScannerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Scan QR Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Simple Scanner -->
                <div id="scanner" style="width: 100%; height: 300px; background: #000;"></div>

                <div class="mt-3">
                    <button class="btn btn-primary w-100" onclick="startSimpleScanner()" id="startBtn">
                        <i class="fas fa-play"></i> Start Camera
                    </button>
                    <button class="btn btn-danger w-100 mt-2" onclick="stopSimpleScanner()" id="stopBtn"
                        style="display:none;">
                        <i class="fas fa-stop"></i> Stop Camera
                    </button>
                </div>

                <div class="alert alert-info mt-3" id="scannerStatus">
                    Click "Start Camera" to begin scanning
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Simple Scanner Implementation
    let simpleScanner = null;

    async function startSimpleScanner() {
        try {
            // Check if library is loaded
            if (typeof Html5Qrcode === 'undefined') {
                alert('QR Scanner library not loaded. Please check internet connection.');
                return;
            }

            // Create scanner instance
            simpleScanner = new Html5Qrcode("scanner");

            // Start scanner
            await simpleScanner.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText) => {
                    // QR detected
                    document.getElementById('scannerStatus').innerHTML =
                        `<div class="alert alert-success">
                        <strong>QR Detected:</strong><br>${decodedText}
                        <br><br>Processing...
                    </div>`;

                    // Stop scanner
                    stopSimpleScanner();

                    // Send to server
                    processQRCode(decodedText);
                },
                (errorMessage) => {
                    // Ignore scanning errors
                }
            );

            // Update UI
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
            document.getElementById('scannerStatus').innerHTML =
                '<div class="alert alert-success">Scanner active. Point camera at QR code.</div>';

        } catch (error) {
            document.getElementById('scannerStatus').innerHTML =
                `<div class="alert alert-danger">
                <strong>Error:</strong> ${error.message}<br>
                Make sure camera permissions are granted.
            </div>`;
            console.error('Scanner error:', error);
        }
    }

    function stopSimpleScanner() {
        if (simpleScanner) {
            simpleScanner.stop();
            simpleScanner = null;
        }
        document.getElementById('startBtn').style.display = 'block';
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('scannerStatus').innerHTML =
            '<div class="alert alert-info">Scanner stopped.</div>';
    }

    function processQRCode(qrData) {
        fetch('/attendance/mark/qr/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ qr_data: qrData })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('scannerStatus').innerHTML =
                        `<div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> 
                    <strong>Success!</strong><br>
                    ${data.message}
                </div>`;

                    // Close modal after 2 seconds
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('qrScannerModal'));
                        if (modal) modal.hide();
                        location.reload();
                    }, 2000);
                } else {
                    document.getElementById('scannerStatus').innerHTML =
                        `<div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i> 
                    <strong>Error:</strong><br>
                    ${data.message}
                    <br><br>
                    <button class="btn btn-sm btn-primary" onclick="startSimpleScanner()">
                        Try Again
                    </button>
                </div>`;
                }
            })
            .catch(error => {
                document.getElementById('scannerStatus').innerHTML =
                    `<div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i> 
                <strong>Network Error:</strong><br>
                Please check your connection.
            </div>`;
            });
    }

    // Update scan button to use simple scanner
    document.getElementById('scanQrBtn').onclick = function () {
        const modal = new bootstrap.Modal(document.getElementById('qrScannerModal'));
        modal.show();

        // Reset scanner when modal opens
        document.getElementById('scanner').innerHTML = '';
        document.getElementById('scannerStatus').innerHTML =
            'Click "Start Camera" to begin scanning';
        document.getElementById('startBtn').style.display = 'block';
        document.getElementById('stopBtn').style.display = 'none';
    };

    // Stop scanner when modal closes
    document.getElementById('qrScannerModal').addEventListener('hidden.bs.modal', function () {
        stopSimpleScanner();
    });
</script>

<!-- Manual Attendance Modal -->
<div class="modal fade" id="manualAttendanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-keyboard me-2"></i>Manual Attendance Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="manualAttendanceForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="event_code" class="form-label">Event Code</label>
                        <input type="text" class="form-control" id="event_code"
                            placeholder="Enter event code (e.g., EVT-001)" required>
                        <div class="form-text">Get the event code from the organizer or event details.</div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check me-1"></i> Mark Attendance
                        </button>
                    </div>
                </form>
                <div id="manualAttendanceResult" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Manual Attendance Modal -->
{% if is_admin or is_organizer %}
<div class="modal fade" id="adminManualAttendance" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-check me-2"></i>Mark Attendance for Student</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="adminAttendanceForm" action="{% url 'mark_manual_attendance' %}" method="POST">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="student_id" class="form-label">Student ID or QR Scan</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="student_id" name="student_id"
                                placeholder="Enter student ID or scan student QR" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="scanStudentQR()">
                                <i class="fas fa-qrcode"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="admin_event_code" class="form-label">Event Code</label>
                        <input type="text" class="form-control" id="admin_event_code" name="event_code"
                            placeholder="Enter event code" required>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-user-check me-1"></i> Mark Attendance
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Attendance History Modal -->
<div class="modal fade" id="attendanceHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-history me-2"></i>My Attendance History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="attendanceHistoryContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading attendance history...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Details Modal -->
<div class="modal fade" id="attendanceDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Attendance Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="attendanceDetailsContent">
                <!-- Loaded via AJAX -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
    // Global variables
    let html5QrCode = null;
    let isScannerActive = false;
    let currentCameraId = null;
    let isFlashOn = false;
    let currentStream = null;

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Attendance system initialized');

        // Setup QR scanner button
        const scanBtn = document.getElementById('scanQrBtn');
        if (scanBtn) {
            scanBtn.addEventListener('click', openQRScanner);
        }

        // Setup scanner modal events
        const scannerModal = document.getElementById('qrScannerModal');
        if (scannerModal) {
            scannerModal.addEventListener('shown.bs.modal', function () {
                initializeScanner();
                loadCameras();
            });

            scannerModal.addEventListener('hidden.bs.modal', function () {
                stopScanner();
            });
        }

        // Setup scanner control buttons
        document.getElementById('startScannerBtn')?.addEventListener('click', startScanner);
        document.getElementById('stopScannerBtn')?.addEventListener('click', stopScanner);
        document.getElementById('flashToggle')?.addEventListener('click', toggleFlash);
        document.getElementById('cameraSelect')?.addEventListener('change', changeCamera);

        // Setup manual attendance form
        const manualForm = document.getElementById('manualAttendanceForm');
        if (manualForm) {
            manualForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const eventCode = document.getElementById('event_code').value;
                submitManualAttendance(eventCode);
            });
        }

        // Setup mark attendance buttons
        document.querySelectorAll('.mark-attendance-btn').forEach(button => {
            button.addEventListener('click', function () {
                const eventId = this.dataset.eventId;
                markAttendanceViaButton(eventId);
            });
        });

        // Generate personal QR if student
        {% if is_student %}
        setTimeout(() => {
            generatePersonalQR();
        }, 1000);
        {% endif %}
    });

    // ========== QR SCANNER FUNCTIONS ==========

    function openQRScanner() {
        console.log('Opening QR scanner...');
        const modal = new bootstrap.Modal(document.getElementById('qrScannerModal'));
        modal.show();
    }

    async function initializeScanner() {
        console.log('Initializing scanner...');

        try {
            // Check camera support
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showToast('Your browser does not support camera access. Please use Chrome, Firefox, or Edge.', 'error');
                return false;
            }

            // Check permissions
            let permissionGranted = false;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                stream.getTracks().forEach(track => track.stop());
                permissionGranted = true;
            } catch (error) {
                if (error.name === 'NotAllowedError') {
                    showToast('Camera permission denied. Please allow camera access.', 'error');
                } else {
                    showToast('Could not access camera: ' + error.message, 'error');
                }
                return false;
            }

            // Initialize QR scanner
            html5QrCode = new Html5Qrcode("qr-reader");
            console.log('Scanner initialized successfully');
            updateScannerStatus('Ready to start', 'primary');
            return true;

        } catch (error) {
            console.error('Scanner initialization error:', error);
            showToast('Failed to initialize scanner: ' + error.message, 'error');
            return false;
        }
    }

    async function loadCameras() {
        try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            const cameraSelect = document.getElementById('cameraSelect');

            if (!cameraSelect) return;

            cameraSelect.innerHTML = '<option value="">Auto-select camera</option>';

            videoDevices.forEach((device, index) => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = device.label || `Camera ${index + 1}`;
                cameraSelect.appendChild(option);
            });

        } catch (error) {
            console.error('Error loading cameras:', error);
        }
    }

    async function startScanner() {
        console.log('Starting scanner...');

        if (!html5QrCode) {
            const initialized = await initializeScanner();
            if (!initialized) return;
        }

        try {
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                console.log('QR Code scanned:', decodedText);
                handleScannedQR(decodedText);
            };

            const qrCodeErrorCallback = (error) => {
                // Ignore common scanning errors
                if (!error.includes('NotFoundException') && !error.includes('NoMultiFormatReader')) {
                    console.log('Scan error:', error);
                }
            };

            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0,
                rememberLastUsedCamera: true
            };

            let cameraConfig;
            if (currentCameraId) {
                cameraConfig = { deviceId: { exact: currentCameraId } };
            } else {
                cameraConfig = { facingMode: "environment" };
            }

            await html5QrCode.start(
                cameraConfig,
                config,
                qrCodeSuccessCallback,
                qrCodeErrorCallback
            );

            // Update UI
            isScannerActive = true;
            document.getElementById('startScannerBtn').style.display = 'none';
            document.getElementById('stopScannerBtn').style.display = 'block';
            updateScannerStatus('Scanning...', 'success');

            // Get video stream for flash control
            const videoElement = document.querySelector('#qr-reader video');
            if (videoElement && videoElement.srcObject) {
                currentStream = videoElement.srcObject;
            }

            console.log('Scanner started successfully');

        } catch (error) {
            console.error('Scanner start error:', error);

            if (error.message.includes('Requested device not found')) {
                showToast('Selected camera not found. Trying default camera...', 'warning');
                currentCameraId = null;
                setTimeout(() => startScanner(), 500);
            } else {
                showToast('Failed to start scanner: ' + error.message, 'error');
            }
        }
    }

    async function stopScanner() {
        console.log('Stopping scanner...');

        if (html5QrCode && isScannerActive) {
            try {
                await html5QrCode.stop();
                isScannerActive = false;

                // Update UI
                document.getElementById('startScannerBtn').style.display = 'block';
                document.getElementById('stopScannerBtn').style.display = 'none';
                updateScannerStatus('Scanner stopped', 'secondary');

                // Turn off flash
                if (isFlashOn) {
                    toggleFlash();
                }

                // Stop stream
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }

                console.log('Scanner stopped successfully');

            } catch (error) {
                console.error('Error stopping scanner:', error);
            }
        }
    }

    async function toggleFlash() {
        if (!currentStream) return;

        try {
            const track = currentStream.getVideoTracks()[0];
            if (!track || !track.getCapabilities().torch) {
                showToast('Flash not supported on this device', 'warning');
                return;
            }

            isFlashOn = !isFlashOn;

            await track.applyConstraints({
                advanced: [{ torch: isFlashOn }]
            });

            const flashBtn = document.getElementById('flashToggle');
            if (flashBtn) {
                flashBtn.innerHTML = isFlashOn ?
                    '<i class="fas fa-lightbulb text-warning"></i> On' :
                    '<i class="fas fa-lightbulb"></i> Off';
                flashBtn.className = isFlashOn ?
                    'btn btn-warning w-100' :
                    'btn btn-outline-secondary w-100';
            }

        } catch (error) {
            console.error('Error toggling flash:', error);
            showToast('Flash control failed', 'warning');
        }
    }

    async function changeCamera(event) {
        const newCameraId = event.target.value;
        console.log('Changing camera to:', newCameraId);

        if (isScannerActive) {
            await stopScanner();
            currentCameraId = newCameraId;
            setTimeout(() => startScanner(), 500);
        } else {
            currentCameraId = newCameraId;
        }
    }

    function updateScannerStatus(message, type = 'info') {
        const statusDiv = document.getElementById('scannerStatus');
        const stateBadge = document.getElementById('scannerState');

        if (statusDiv && stateBadge) {
            statusDiv.className = `alert alert-${type} d-flex align-items-center mb-3`;
            statusDiv.querySelector('.flex-grow-1').textContent = message;
            stateBadge.className = `badge bg-${type}`;
            stateBadge.textContent = message.split(' ')[0];
        }
    }

    function handleScannedQR(qrData) {
        console.log('Processing scanned QR:', qrData);

        stopScanner();
        updateScannerStatus('Processing QR code...', 'info');

        // Process the QR code
        processScannedQR(qrData);
    }

    // ========== ATTENDANCE FUNCTIONS ==========

    function processScannedQR(qrData) {
        const scannerContainer = document.getElementById('scannerContainer');
        if (!scannerContainer) return;

        // Show processing message
        scannerContainer.innerHTML = `
            <div class="d-flex flex-column align-items-center justify-content-center h-100 bg-light rounded">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Processing QR Code...</h5>
                <p class="text-muted">Please wait</p>
            </div>
        `;

        // Send to server
        fetch('/attendance/mark/qr/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                qr_data: qrData,
                scan_time: new Date().toISOString()
            })
        })
            .then(response => response.json())
            .then(data => {
                console.log('Server response:', data);

                if (data.success) {
                    scannerContainer.innerHTML = `
                    <div class="d-flex flex-column align-items-center justify-content-center h-100 bg-light rounded">
                        <div class="text-success mb-3">
                            <i class="fas fa-check-circle fa-4x"></i>
                        </div>
                        <h4 class="text-success">Success!</h4>
                        <p>${data.message}</p>
                        ${data.event ? `
                            <div class="card mt-3 w-100">
                                <div class="card-body">
                                    <h6 class="card-title">${data.event.title}</h6>
                                    <p class="card-text small mb-1">
                                        <i class="fas fa-calendar"></i> ${data.event.date}
                                    </p>
                                    <p class="card-text small mb-1">
                                        <i class="fas fa-clock"></i> ${data.event.time}
                                    </p>
                                    <p class="card-text small">
                                        <i class="fas fa-map-marker-alt"></i> ${data.event.venue}
                                    </p>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;

                    // Close modal after 3 seconds
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('qrScannerModal'));
                        if (modal) modal.hide();

                        // Refresh page after 1 second
                        setTimeout(() => location.reload(), 1000);
                    }, 3000);

                } else {
                    scannerContainer.innerHTML = `
                    <div class="d-flex flex-column align-items-center justify-content-center h-100 bg-light rounded">
                        <div class="text-danger mb-3">
                            <i class="fas fa-exclamation-triangle fa-4x"></i>
                        </div>
                        <h4 class="text-danger">Error!</h4>
                        <p>${data.message || 'Invalid QR code'}</p>
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="restartScanner()">
                                <i class="fas fa-redo"></i> Scan Again
                            </button>
                        </div>
                    </div>
                `;
                }
            })
            .catch(error => {
                console.error('Network error:', error);
                scannerContainer.innerHTML = `
                <div class="d-flex flex-column align-items-center justify-content-center h-100 bg-light rounded">
                    <div class="text-danger mb-3">
                        <i class="fas fa-wifi-slash fa-4x"></i>
                    </div>
                    <h4 class="text-danger">Network Error</h4>
                    <p>Please check your connection and try again</p>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="restartScanner()">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                </div>
            `;
            });
    }

    function restartScanner() {
        const scannerContainer = document.getElementById('scannerContainer');
        if (!scannerContainer) return;

        scannerContainer.innerHTML = '<div id="qr-reader" style="width: 100%; height: 300px;"></div><div class="scanner-overlay"><div class="scanner-frame"><div class="scanner-corner tl"></div><div class="scanner-corner tr"></div><div class="scanner-corner bl"></div><div class="scanner-corner br"></div></div></div>';

        html5QrCode = new Html5Qrcode("qr-reader");
        setTimeout(() => startScanner(), 500);
    }

    function markAttendanceViaButton(eventId) {
        const btn = document.querySelector(`[data-event-id="${eventId}"]`);
        const originalHTML = btn.innerHTML;
        const originalClass = btn.className;

        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processing...';
        btn.className = 'btn btn-sm btn-secondary';
        btn.disabled = true;

        fetch('/attendance/mark/qr/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                qr_data: `${eventId}|direct`
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    btn.innerHTML = '<i class="fas fa-check me-1"></i> Marked ';
                    btn.className = 'btn btn-sm btn-success';

                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showToast(data.message || 'Failed to mark attendance', 'error');
                    btn.innerHTML = originalHTML;
                    btn.className = originalClass;
                    btn.disabled = false;
                }
            })
            .catch(error => {
                showToast('Network error. Please try again.', 'error');
                btn.innerHTML = originalHTML;
                btn.className = originalClass;
                btn.disabled = false;
            });
    }

    function submitManualAttendance(eventCode) {
        const resultDiv = document.getElementById('manualAttendanceResult');
        resultDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin me-2"></i> Processing attendance...
            </div>
        `;

        fetch('/attendance/quick-manual/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ event_code: eventCode })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <div class="d-flex">
                            <i class="fas fa-check-circle fa-2x me-3 text-success"></i>
                            <div>
                                <h5 class="alert-heading">Success!</h5>
                                <p>${data.message}</p>
                                <hr>
                                <div class="row">
                                    <div class="col-6">
                                        <small><strong>Event:</strong></small>
                                        <p>${data.data.event}</p>
                                    </div>
                                    <div class="col-6">
                                        <small><strong>Time:</strong></small>
                                        <p>${data.data.time}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                    setTimeout(() => {
                        $('#manualAttendanceModal').modal('hide');
                        setTimeout(() => location.reload(), 1000);
                    }, 2000);
                } else {
                    resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <div class="d-flex">
                            <i class="fas fa-exclamation-circle fa-2x me-3 text-danger"></i>
                            <div>
                                <h5 class="alert-heading">Error!</h5>
                                <p>${data.message}</p>
                                <button class="btn btn-sm btn-outline-danger mt-2" onclick="submitManualAttendance('${eventCode}')">
                                    <i class="fas fa-redo me-1"></i> Try Again
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Network Error:</strong> Please check your connection.
                </div>
            `;
            });
    }

    function generatePersonalQR() {
        const qrPreview = document.getElementById('qrPreview');
        if (!qrPreview) return;

        qrPreview.innerHTML = `
            <div class="text-center w-100 h-100 d-flex flex-column align-items-center justify-content-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Generating your personal QR code...</p>
            </div>
        `;

        fetch('/attendance/generate-personal-qr/', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    qrPreview.innerHTML = `
                    <img src="${data.qr_code}" alt="Personal QR Code" 
                         class="img-fluid w-100 h-100" style="object-fit: contain;">
                `;
                    showToast('Personal QR code generated!', 'success');
                } else {
                    qrPreview.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                        <p>Failed to generate QR</p>
                        <button class="btn btn-sm btn-primary" onclick="generatePersonalQR()">
                            <i class="fas fa-redo me-1"></i> Retry
                        </button>
                    </div>
                `;
                }
            })
            .catch(error => {
                qrPreview.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-wifi-slash fa-2x text-danger mb-3"></i>
                    <p>Network error</p>
                </div>
            `;
            });
    }

    function loadAttendanceHistory() {
        const contentDiv = document.getElementById('attendanceHistoryContent');

        fetch('/attendance/history/')
            .then(response => response.text())
            .then(html => {
                contentDiv.innerHTML = html;
            })
            .catch(error => {
                contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Failed to load attendance history
                </div>
            `;
            });
    }

    function viewAttendanceDetails(attendanceId) {
        console.log('Viewing details for:', attendanceId);

        const modalContent = document.getElementById('attendanceDetailsContent');
        if (modalContent) {
            modalContent.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading details...</p>
                </div>
            `;
        }

        fetch(`/attendance/details/${attendanceId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (modalContent) {
                        modalContent.innerHTML = `
                        <div class="attendance-details">
                            <h6 class="text-primary mb-3">Attendance Details</h6>
                            <div class="card mb-2">
                                <div class="card-body p-3">
                                    <h6 class="card-subtitle mb-2 text-muted">Event Information</h6>
                                    <p class="mb-1"><strong>${data.event.title}</strong></p>
                                    <p class="text-muted small mb-1">${data.event.venue}</p>
                                    <p class="text-muted small">${data.event.date}  ${data.event.time}</p>
                                </div>
                            </div>
                            
                            <div class="card mb-2">
                                <div class="card-body p-3">
                                    <h6 class="card-subtitle mb-2 text-muted">Student Information</h6>
                                    <p class="mb-1"><strong>${data.student.name}</strong></p>
                                    <p class="text-muted small mb-1">ID: ${data.student.id}</p>
                                    <p class="text-muted small">Email: ${data.student.email}</p>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-body p-3">
                                    <h6 class="card-subtitle mb-2 text-muted">Attendance Details</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <p class="mb-1 small">Marked At:</p>
                                            <p class="fw-bold">${data.attendance.marked_at}</p>
                                        </div>
                                        <div class="col-6">
                                            <p class="mb-1 small">Method:</p>
                                            <span class="badge bg-${data.attendance.method.toLowerCase()}">
                                                ${data.attendance.method}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <p class="mb-1 small">Status:</p>
                                            <span class="badge bg-${data.attendance.status_color}">
                                                ${data.attendance.status}
                                            </span>
                                        </div>
                                        <div class="col-6">
                                            <p class="mb-1 small">Verified:</p>
                                            <span class="badge ${data.attendance.verified ? 'bg-success' : 'bg-warning'}">
                                                ${data.attendance.verified ? 'Yes' : 'No'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    }

                    const modal = new bootstrap.Modal(document.getElementById('attendanceDetailsModal'));
                    modal.show();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (modalContent) {
                    modalContent.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Failed to load attendance details
                    </div>
                `;
                }
            });
    }

    function refreshOngoingEvents() {
        showToast('Refreshing ongoing events...', 'info');
        setTimeout(() => location.reload(), 500);
    }

    function refreshRecentAttendance() {
        showToast('Refreshing attendance records...', 'info');
        setTimeout(() => location.reload(), 500);
    }

    function scanStudentQR() {
        showToast('Please use a physical QR scanner or enter student ID manually', 'info');
    }

    // ========== UTILITY FUNCTIONS ==========

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showToast(message, type = 'info') {
        // Remove existing toasts
        document.querySelectorAll('.toast-notification').forEach(toast => toast.remove());

        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        toast.innerHTML = `
            <div class="toast-content d-flex align-items-center">
                <div class="toast-icon me-3">
                    ${type === 'success' ? '<i class="fas fa-check-circle text-success fa-lg"></i>' :
                type === 'error' ? '<i class="fas fa-exclamation-circle text-danger fa-lg"></i>' :
                    '<i class="fas fa-info-circle text-info fa-lg"></i>'}
                </div>
                <div class="toast-message flex-grow-1">${message}</div>
                <button class="btn-close ms-2" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;

        document.body.appendChild(toast);

        // Animate in
        setTimeout(() => toast.classList.add('show'), 10);

        // Auto remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }
        }, 5000);
    }

    // Make functions globally available
    window.showToast = showToast;
    window.generatePersonalQR = generatePersonalQR;
    window.loadAttendanceHistory = loadAttendanceHistory;
    window.viewAttendanceDetails = viewAttendanceDetails;
    window.refreshOngoingEvents = refreshOngoingEvents;
    window.refreshRecentAttendance = refreshRecentAttendance;
    window.scanStudentQR = scanStudentQR;
    window.restartScanner = restartScanner;

    // Load attendance history when modal opens
    document.getElementById('attendanceHistoryModal')?.addEventListener('shown.bs.modal', loadAttendanceHistory);
</script>
{% endblock %}